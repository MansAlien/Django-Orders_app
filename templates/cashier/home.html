{% extends 'base.html' %}
  {% block content %} 
<style>
form label {
  display: none;
}
</style>
<div class="p-4 md:ml-64">
  <!-- Breadcrumb -->
  <nav class="flex mt-12 p-4" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
      <li class="inline-flex items-center space-x-1 text-gray-400 hover:text-white">
        <i class=" fas fa-home"></i>
        <a href="{% url 'home' %}" class="inline-flex items-center text-sm font-medium">
          Home
        </a> 
        <i class="fa-solid fa-angle-right"></i>
      </li>
      <li class="inline-flex items-center space-x-1 text-gray-400 hover:text-white">
        <span class="ms-1 text-sm font-medium md:ms-2 text-gray-400">
          Cashier
        </span>
      </li>
    </ol>
  </nav>
  <div class="px-4 rounded-lg h-full">
    <!--Customer Section-->
    <div class="grid grid-cols-4 gap-3 h-full">
      <div class="col-span-3 h-full bg-gray-800 rounded-tl-lg py-2 px-5 m-0">
        <div class="grid grid-cols-3 px-5"> 
          <div class="flex items-center gap-1 ">
            <div>
              {% csrf_token %}
              <form id="customer_id_form">
                <input
                hx-post="{% url 'customer_with_id' %}" 
                hx-trigger="keyup changed delay:1s from:input[id='customer_id']"
                hx-target="#customer"
                hx-swap="innerHTML"
                name="customer_id"
                type="number" 
                aria-describedby="helper-text-explanation" 
                id="customer_id"
                type="number" aria-describedby="helper-text-explanation" id="customer_id" 
                class="border text-sm rounded-lg block w-[11rem] mt-1.5 p-2.5 bg-gray-700 border-gray-600
                placeholder-gray-400 text-white focus:ring-blue-500 focus:border-blue-500"
                placeholder="ID or Phone" />
              </form>
            </div>
            <button data-tooltip-target="tooltip-right" data-tooltip-placement="right">
              <i class="text-lg text-gray-400 fa-regular fa-circle-info"></i>
            </button>
            <div 
              id="tooltip-right" role="tooltip" 
              class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium
              text-white rounded-lg shadow-sm opacity-0 tooltip bg-gray-500">
              <p> - Write the Customer ID  or Phone</p>
              <p> - press "Enter" from the keyboard or anywhere out of the input </p>
              <p> - If the user is exist the next form will be filled with the customer data </p>
              <div class="tooltip-arrow" data-popper-arrow></div>
            </div>
          </div>
          <div class="col-span-2"> 
            <div 
              hx-get="{% url "customer_info" %}"
              hx-trigger="customer_info from:body" 
              hx-target="this"
              hx-swap="innerHTML"
              id="customer"
              class=" col-span-5">
              {% include "cashier/forms/customer_info.html" %}
            </div>
          </div>
        </div>
      </div>
      <div class="flex h-full bg-gray-800 justify-center gap-1 items-center rounded-tr-lg p-10">
        <div>
          {% csrf_token %}
          <form id="order_id_form">
            <input
            _="on keyup set #form_order_id's value to my.value"
            type="number" aria-describedby="helper-text-explanation" id="order_id" 
            class="border text-sm rounded-lg block w-28 p-2.5 bg-gray-700 border-gray-600
            placeholder-gray-400 text-white focus:ring-blue-500 focus:border-blue-500"
            placeholder="Order ID" />
          </form>
        </div>
        <button data-tooltip-target="tooltip-bottom" data-tooltip-placement="bottom">
          <i class="text-lg text-gray-400 fa-regular fa-circle-info"></i>
        </button>
        <div 
          id="tooltip-bottom" role="tooltip"
          class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium
          text-white rounded-lg shadow-sm opacity-0 tooltip bg-gray-500">
          <p> - Write the Order ID </p>
          <p> - press "Enter" from the keyboard </p>
          <p> - If the order is exist it will get the order data </p>
          <div class="tooltip-arrow" data-popper-arrow></div>
        </div>
      </div>
    </div>

    <!--Order Section-->
    <div class="grid grid-cols-4 gap-3 mt-3" style="height: 35rem" x-data="{count: 1}">
      <!--Products list-->
      <div class=" bg-gray-800 rounded-bl-lg overflow-y-auto h-full">
        <div class="bg-gray-700 flex justify-center text-gray-300 p-2 sticky top-0">
          <p class="text-lg border-b"> Products List </p>
        </div>
        <div id="product_list" class="pt-2">
        </div>
      </div>

      <!--Order Details-->
      <div class="col-span-3">
        <div class="grid grid-rows-7 h-full gap-y-3">

          <!--Order Details Table-->
          <div
            id="order_details"
            class="row-span-4 bg-gray-800 h-full">
            {% include 'cashier/tables/order_details_table.html' %}
          </div>

          <!--Order Details Payment-->
          <form id="payment_form" class="row-span-2 h-full" hx-post="{% url 'create_order' %}">
            {% csrf_token %}
            <div class=" flex justify-between items-center bg-gray-800 h-full px-5">
              <div class="flex justify-center items-center px-5 gap-10">
                <input type="hidden" name="customer_id" id="form_customer_id">
                <input type="hidden" name="order_id" id="form_order_id">
                <div class="text-center text-white">
                  <p class="block mb-5 text-base font-medium text-gray-400">Befor Discount</p>
                  <input
                  class="border-none bg-gray-800 text-center text-white w-20 px-0 text-base"
                  type="text" id="before_discount" value='0.0' readonly />
                </div>
                <div class="text-center">
                  <label for="payment_discount" class="block mb-5 text-base font-medium text-gray-400">Discount %</label>
                  <input
                  name="discount"
                  id="payment_discount"
                  type="number" aria-describedby="helper-text-explanation" id="discount" 
                  class="border text-base text-center rounded-lg block w-24 p-2 bg-gray-700 border-gray-600
                  placeholder-gray-400 text-white focus:ring-blue-500 focus:border-blue-500"
                  placeholder="0 %" 
                  min="0"
                  max="100"
                  _="on keyup call calculateTotal()" />
                </div>
                <div class="text-center text-white">
                  <p class="block mb-5 text-base font-medium text-gray-400">After Discount</p>
                  <input
                  class="border-none bg-gray-800 text-center text-white w-20 px-0"
                  type="text" id="after_discount" value='0.0' readonly />
                </div>
              </div>

              <div class="flex justify-center items-center px-5 gap-10">
                <div class="text-center">
                  <label for="payment_method" class="block mb-5 text-base font-medium text-gray-400">Payment</label>
                  <select 
                    id="payment_method"
                    name="payment_method"
                    class=" border text-base rounded-lg
                    block p-2 bg-gray-700 border-gray-600 placeholder-gray-400
                    text-white focus:ring-blue-500 focus:border-blue-500">
                    <option value="C" selected>Cash</option>
                    <option value="O">Online</option>
                    <option value="V">Visa</option>
                  </select>
                </div>
                <div class="text-center">
                  <label for="paid" class="block mb-5 text-base font-medium text-gray-400">Paid</label>
                  <input
                  _='on keyup call calculateTotal()'
                  name="paid"
                  type="number" aria-describedby="helper-text-explanation" id="paid" 
                  class="border text-base text-center rounded-lg block w-24 p-2 bg-gray-700 border-gray-600
                  placeholder-gray-400 text-white focus:ring-blue-500 focus:border-blue-500"
                  placeholder="0.0" />
                </div>
                <div class="text-center">
                  <label for="remaining" class="block mb-5 text-base font-medium text-gray-400">Remaining</label>
                  <input type="number" aria-describedby="helper-text-explanation" id="remaining" 
                  class="border-none text-base text-red-500 text-center rounded-lg block w-24 p-2 bg-gray-800 
                  placeholder-gray-400"
                  placeholder="0.0" readonly />
                </div>
              </div>
            </div>
          </form>

            <!--Order Details buttons-->
            <div class="row-span-1 flex justify-between items-center bg-gray-800 h-full px-5 rounded-br-lg">
              <div class="flex justify-center items-center px-5 gap-10">
                <button 
                  id="ok_button"
                  form="payment_form"
                  class="block text-white focus:ring-4 focus:outline-none
                  font-medium rounded-lg text-sm px-5 py-2.5 text-center bg-blue-600 hover:bg-blue-700 
                  focus:ring-blue-800 my-3" type="submit">
                  OK
                </button>
                <button 
                  form="order_details_form"
                  class="block text-white focus:ring-4 focus:outline-none
                  font-medium rounded-lg text-sm px-5 py-2.5 text-center bg-blue-600 hover:bg-blue-700 
                  focus:ring-blue-800 my-3" type="submit">
                  OK + Print
                </button>
              </div>

              <div class="flex justify-center items-center px-5 gap-10">
                <button 
                  class="focus:outline-none text-white bg-yellow-400 hover:bg-yellow-500 focus:ring-4
                  font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 focus:ring-yellow-900" type="button">
                  Open
                </button>
                <button 
                  class=" border focus:outline-none focus:ring-4
                  font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 bg-gray-800 text-white border-gray-600
                  hover:bg-gray-700 hover:border-gray-600 focus:ring-gray-700" type="button">
                  Clear
                </button>
              </div>
            </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Main Modal -->
  <div
    id="modal_div"
    class="hidden overflow-y-auto overflow-x-hidden fixed left-0 top-0 bg-black 
    bg-opacity-50 w-screen h-screen flex justify-center items-center z-50 md:inset-0 ">
    <div class="relative p-4 w-full max-w-lg max-h-full">
      <div class="relative rounded-lg shadow bg-gray-700 p-6 my-6">
        <div id="modal_form"> </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block sidecontent %}
{% for category in category_list %}
{% if category.is_active %}
<li class="item">
  <a
    hx-get="{% url 'product_list' category.id %}"
    hx-target="#product_list"
    _="on click remove .bg-gray-700 from <a/> in .ul_items then add .bg-gray-700 to me"
    class="flex items-top p-2 rounded-lg text-white 
    hover:bg-gray-700 group cursor-pointer max-h-full">
    <span class="inline-block transition duration-75 
      text-gray-200 group-hover:text-white">
      <i class="text-xl fa-solid fa-circle-plus"></i>
    </span>
    <span class="ms-5 text-gray-300 text-lg">{{ category.name }}</span>
  </a>
</li>
{% endif %}
{% endfor %}
{% endblock sidecontent %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  document.getElementById('customer_id').addEventListener('keypress', function (event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      const customerId = this.value;
      fetch('{% url "cashier" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCookie('csrftoken') // Ensure CSRF token is included
        },
        body: new URLSearchParams({
          'customer_id': customerId
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert(data.error); // Show error message if customer not found
          } else {
            // Populate form fields with fetched data
            document.getElementById('id_phone').value = data.phone;
            document.getElementById('id_name_one').value = data.name_one;
            document.getElementById('id_name_two').value = data.name_two;
            document.getElementById('id_whatsapp').value = data.whatsapp;
          }
        })
        .catch(error => console.error('Error:', error));
    }
  });
});
// Function to get CSRF token from cookies
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
